// ============================================================
// SIM4LON DATABASE SCHEMA
// Sistem Informasi Manajemen Distribusi LPG
// ============================================================
//
// SCHEMA VERSION: 2.0 (Cleaned up)
// LAST UPDATED: 2025-12-16
//
// TABLES:
//   Core:      users, pangkalans, drivers
//   Orders:    orders, order_items, timeline_tracks
//   Payments:  invoices, payment_records, order_payment_details
//   Products:  lpg_products (lpg_prices deprecated)
//   Tracking:  stock_histories, activity_logs
// ============================================================

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  extensions = [uuid_ossp(map: "uuid-ossp"), pgcrypto]
}

// ============================================================
// CORE TABLES
// ============================================================

/// User account for admin and operator login
model users {
  id           String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  code         String    @unique @db.VarChar(20) /// Display code: USR-001
  email        String    @unique @db.VarChar(255)
  password     String    @db.VarChar(255)
  name         String    @db.VarChar(255)
  phone        String?   @db.VarChar(20)
  avatar_url   String?
  role         user_role @default(OPERATOR)
  pangkalan_id String?   @db.Uuid /// Link to pangkalan for PANGKALAN role
  is_active    Boolean   @default(true)
  created_at   DateTime  @default(now()) @db.Timestamptz(6)
  updated_at   DateTime  @default(now()) @db.Timestamptz(6)
  deleted_at   DateTime? @db.Timestamptz(6)

  // Relations
  pangkalans      pangkalans?       @relation(fields: [pangkalan_id], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "fk_users_pangkalan")
  activity_logs   activity_logs[]
  payment_records payment_records[]
  stock_histories stock_histories[]

  @@index([email], map: "idx_users_email")
  @@index([role], map: "idx_users_role")
  @@index([pangkalan_id], map: "idx_users_pangkalan")
}

/// LPG Distribution Agent / Pangkalan
model pangkalans {
  id         String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  code       String    @unique @db.VarChar(20) /// Display code: PKL-001
  name       String    @db.VarChar(255)
  address    String
  region     String?   @db.VarChar(100)
  pic_name   String?   @db.VarChar(255) /// Person In Charge name
  phone      String?   @db.VarChar(20)
  email      String?   @db.VarChar(255) /// For sending invoices
  capacity   Int? /// Storage capacity in units
  note       String?
  is_active  Boolean   @default(true)
  created_at DateTime  @default(now()) @db.Timestamptz(6)
  updated_at DateTime  @default(now()) @db.Timestamptz(6)
  deleted_at DateTime? @db.Timestamptz(6)

  // Relations
  orders                    orders[]
  users                     users[] /// Users linked to this pangkalan
  consumers                 consumers[] /// Consumers of this pangkalan
  consumer_orders           consumer_orders[] /// Consumer orders for this pangkalan
  expenses                  expenses[] /// Expense records for this pangkalan
  pangkalan_stocks          pangkalan_stocks[] /// Stock levels for this pangkalan
  pangkalan_stock_movements pangkalan_stock_movements[] /// Stock movement history

  @@index([region], map: "idx_pangkalans_region")
  @@index([is_active], map: "idx_pangkalans_active")
}

/// Expense/Pengeluaran records for pangkalan
model expenses {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  pangkalan_id String   @db.Uuid
  category     String   @db.VarChar(50)
  amount       Decimal  @db.Decimal(15, 2)
  description  String?
  expense_date DateTime @default(now()) @db.Timestamptz(6)
  created_at   DateTime @default(now()) @db.Timestamptz(6)
  updated_at   DateTime @default(now()) @db.Timestamptz(6)

  // Relations
  pangkalans pangkalans @relation(fields: [pangkalan_id], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "fk_expenses_pangkalan")

  @@index([pangkalan_id], map: "idx_expenses_pangkalan")
  @@index([expense_date(sort: Desc)], map: "idx_expenses_date")
  @@index([category], map: "idx_expenses_category")
}

/// Consumer-specific pricing for pangkalan
model consumer_pricing {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  pangkalan_id String   @db.Uuid
  consumer_id  String   @db.Uuid
  lpg_type     lpg_type
  price        Decimal  @db.Decimal(15, 2)
  created_at   DateTime @default(now()) @db.Timestamptz(6)
  updated_at   DateTime @default(now()) @db.Timestamptz(6)

  // Relations
  consumers consumers @relation(fields: [consumer_id], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "fk_consumer_pricing_consumer")

  @@unique([consumer_id, lpg_type], map: "idx_consumer_pricing_unique")
  @@index([pangkalan_id], map: "idx_consumer_pricing_pangkalan")
  @@index([consumer_id], map: "idx_consumer_pricing_consumer")
}

/// Pangkalan stock levels per LPG type
model pangkalan_stocks {
  id             String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  pangkalan_id   String   @db.Uuid
  lpg_type       lpg_type
  qty            Int      @default(0)
  warning_level  Int      @default(20)
  critical_level Int      @default(10)
  created_at     DateTime @default(now()) @db.Timestamptz(6)
  updated_at     DateTime @default(now()) @db.Timestamptz(6)

  // Relations
  pangkalans pangkalans @relation(fields: [pangkalan_id], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "fk_pangkalan_stocks_pangkalan")

  @@unique([pangkalan_id, lpg_type], map: "idx_pangkalan_stocks_unique")
  @@index([pangkalan_id], map: "idx_pangkalan_stocks_pangkalan")
}

/// Stock movement history for pangkalan
model pangkalan_stock_movements {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  pangkalan_id  String   @db.Uuid
  lpg_type      lpg_type
  movement_type String   @db.VarChar(20)
  qty           Int
  source        String?  @db.VarChar(50)
  reference_id  String?  @db.Uuid
  note          String?
  movement_date DateTime @default(now()) @db.Timestamptz(6)
  created_at    DateTime @default(now()) @db.Timestamptz(6)

  // Relations
  pangkalans pangkalans @relation(fields: [pangkalan_id], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "fk_pangkalan_stock_movements_pangkalan")

  @@index([pangkalan_id], map: "idx_pangkalan_stock_movements_pangkalan")
  @@index([movement_date(sort: Desc)], map: "idx_pangkalan_stock_movements_date")
  @@index([lpg_type], map: "idx_pangkalan_stock_movements_lpg")
}

/// Delivery driver information
model drivers {
  id         String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  code       String    @unique @db.VarChar(20) /// Display code: DRV-001
  name       String    @db.VarChar(255)
  phone      String?   @db.VarChar(20)
  vehicle_id String?   @db.VarChar(20) /// License plate number
  note       String?
  is_active  Boolean   @default(true)
  created_at DateTime  @default(now()) @db.Timestamptz(6)
  updated_at DateTime  @default(now()) @db.Timestamptz(6)
  deleted_at DateTime? @db.Timestamptz(6)

  // Relations
  orders orders[]

  @@index([is_active], map: "idx_drivers_active")
}

// ============================================================
// PRODUCT & STOCK TABLES
// ============================================================

/// LPG Product catalog with direct pricing
model lpg_products {
  id            String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name          String       @db.VarChar(100) /// e.g., "Elpiji 3kg Hijau"
  size_kg       Decimal      @db.Decimal(5, 2) /// Weight: 3.00, 12.00, 50.00
  category      lpg_category @default(NON_SUBSIDI)
  color         String?      @db.VarChar(50) /// hijau, biru, pink
  description   String?
  selling_price Decimal      @default(0) @db.Decimal(15, 2) /// Harga jual
  cost_price    Decimal?     @db.Decimal(15, 2) /// Harga beli (untuk profit margin)
  is_active     Boolean      @default(true)
  created_at    DateTime     @default(now()) @db.Timestamptz(6)
  updated_at    DateTime     @default(now()) @db.Timestamptz(6)
  deleted_at    DateTime?    @db.Timestamptz(6)

  // Relations
  stock_histories stock_histories[]

  @@index([category], map: "idx_lpg_products_category")
  @@index([is_active], map: "idx_lpg_products_active")
}

/// Stock movement history (MASUK/KELUAR)
model stock_histories {
  id                  String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  lpg_product_id      String?             @db.Uuid /// Reference to product
  lpg_type            lpg_type? /// @deprecated - Legacy field for backward compat
  movement_type       stock_movement_type /// MASUK or KELUAR
  qty                 Int /// Quantity moved
  note                String?
  recorded_by_user_id String?             @db.Uuid
  timestamp           DateTime            @default(now()) @db.Timestamptz(6)
  created_at          DateTime            @default(now()) @db.Timestamptz(6)

  // Relations
  lpg_product lpg_products? @relation(fields: [lpg_product_id], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "fk_stock_lpg_product")
  users       users?        @relation(fields: [recorded_by_user_id], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "fk_stock_user")

  @@index([lpg_product_id], map: "idx_stock_product")
  @@index([lpg_type], map: "idx_stock_type")
  @@index([movement_type], map: "idx_stock_movement")
  @@index([timestamp(sort: Desc)], map: "idx_stock_timestamp")
}

// ============================================================
// ORDER TABLES
// ============================================================

/// Main order/pesanan record
model orders {
  id             String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  code           String         @unique @db.VarChar(20) /// Display: ORD-0001
  pangkalan_id   String         @db.Uuid
  driver_id      String?        @db.Uuid
  order_date     DateTime       @default(dbgenerated("CURRENT_DATE")) @db.Date
  current_status status_pesanan @default(DRAFT)
  subtotal       Decimal        @default(0) @db.Decimal(15, 2) /// Before tax
  tax_amount     Decimal        @default(0) @db.Decimal(15, 2) /// PPN 12% for non-subsidi
  total_amount   Decimal        @default(0) @db.Decimal(15, 2) /// subtotal + tax
  note           String?
  created_at     DateTime       @default(now()) @db.Timestamptz(6)
  updated_at     DateTime       @default(now()) @db.Timestamptz(6)
  deleted_at     DateTime?      @db.Timestamptz(6)

  // Relations
  pangkalans            pangkalans             @relation(fields: [pangkalan_id], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "fk_orders_pangkalan")
  drivers               drivers?               @relation(fields: [driver_id], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "fk_orders_driver")
  order_items           order_items[]
  order_payment_details order_payment_details?
  invoices              invoices[]
  payment_records       payment_records[]
  timeline_tracks       timeline_tracks[]
  activity_logs         activity_logs[]

  @@index([current_status], map: "idx_orders_status")
  @@index([pangkalan_id], map: "idx_orders_pangkalan")
  @@index([order_date], map: "idx_orders_date")
  @@index([created_at(sort: Desc)], map: "idx_orders_created")
}

/// Individual item in an order
model order_items {
  id             String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  order_id       String   @db.Uuid
  lpg_type       lpg_type /// Product type enum
  label          String?  @db.VarChar(50) /// Display name
  price_per_unit Decimal  @db.Decimal(15, 2)
  qty            Int
  sub_total      Decimal? @db.Decimal(15, 2)
  is_taxable     Boolean  @default(false) /// true for NON_SUBSIDI (12% PPN)
  tax_amount     Decimal  @default(0) @db.Decimal(15, 2)
  created_at     DateTime @default(now()) @db.Timestamptz(6)
  updated_at     DateTime @default(now()) @db.Timestamptz(6)

  // Relations
  orders orders @relation(fields: [order_id], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "fk_order_items_order")

  @@index([order_id], map: "idx_order_items_order")
}

/// Order status timeline tracking
model timeline_tracks {
  id          String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  order_id    String         @db.Uuid
  status      status_pesanan /// Status at this point
  description String?
  note        String?
  created_at  DateTime       @default(now()) @db.Timestamptz(6)

  // Relations
  orders orders @relation(fields: [order_id], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "fk_timeline_orders")

  @@index([order_id], map: "idx_timeline_order")
  @@index([order_id, created_at(sort: Desc)], map: "idx_timeline_created")
}

// ============================================================
// PAYMENT TABLES
// ============================================================

/// Invoice generated from order
model invoices {
  id              String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  order_id        String    @db.Uuid
  invoice_number  String?   @unique @db.VarChar(50) /// INV-2024-0001
  invoice_date    DateTime  @default(dbgenerated("CURRENT_DATE")) @db.Date
  due_date        DateTime? @db.Date
  billing_address String?
  billed_to_name  String?   @db.VarChar(255)
  sub_total       Decimal   @db.Decimal(15, 2)
  tax_rate        Decimal?  @default(0) @db.Decimal(5, 2)
  tax_amount      Decimal?  @default(0) @db.Decimal(15, 2)
  grand_total     Decimal   @db.Decimal(15, 2)
  payment_status  String?   @default("UNPAID") @db.VarChar(50) /// UNPAID, PARTIAL, PAID
  created_at      DateTime  @default(now()) @db.Timestamptz(6)
  updated_at      DateTime  @default(now()) @db.Timestamptz(6)
  deleted_at      DateTime? @db.Timestamptz(6)

  // Relations
  orders          orders            @relation(fields: [order_id], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "fk_invoices_order")
  payment_records payment_records[]

  @@index([order_id], map: "idx_invoices_order")
  @@index([payment_status], map: "idx_invoices_status")
}

/// Quick payment summary per order (one-to-one)
model order_payment_details {
  id             String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  order_id       String          @unique @db.Uuid
  is_paid        Boolean         @default(false)
  is_dp          Boolean         @default(false) /// Down payment flag
  payment_method payment_method?
  amount_paid    Decimal?        @default(0) @db.Decimal(15, 2)
  payment_date   DateTime?       @db.Timestamptz(6)
  proof_url      String? /// Payment proof image
  created_at     DateTime        @default(now()) @db.Timestamptz(6)
  updated_at     DateTime        @default(now()) @db.Timestamptz(6)

  // Relations
  orders orders @relation(fields: [order_id], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "fk_payment_details_order")
}

/// Individual payment transaction records
model payment_records {
  id                  String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  order_id            String?        @db.Uuid
  invoice_id          String?        @db.Uuid
  method              payment_method
  amount              Decimal        @db.Decimal(15, 2)
  payment_time        DateTime       @default(now()) @db.Timestamptz(6)
  proof_url           String?
  recorded_by_user_id String         @db.Uuid
  note                String?
  created_at          DateTime       @default(now()) @db.Timestamptz(6)

  // Relations
  orders   orders?   @relation(fields: [order_id], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "fk_records_order")
  invoices invoices? @relation(fields: [invoice_id], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "fk_records_invoice")
  users    users     @relation(fields: [recorded_by_user_id], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "fk_records_user")

  @@index([order_id], map: "idx_payment_records_order")
  @@index([payment_time(sort: Desc)], map: "idx_payment_records_time")
}

// ============================================================
// ACTIVITY TRACKING
// ============================================================

/// System activity logs for audit trail
model activity_logs {
  id             String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id        String?         @db.Uuid
  order_id       String?         @db.Uuid
  type           String          @db.VarChar(50) /// order_created, stock_updated, etc.
  title          String          @db.VarChar(255)
  description    String?
  pangkalan_name String?         @db.VarChar(255) /// Denormalized for display
  detail_numeric Decimal?        @db.Decimal(15, 2)
  icon_name      String?         @db.VarChar(50) /// Lucide icon name
  order_status   status_pesanan?
  timestamp      DateTime        @default(now()) @db.Timestamptz(6)
  created_at     DateTime        @default(now()) @db.Timestamptz(6)

  // Relations
  users  users?  @relation(fields: [user_id], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "fk_logs_user")
  orders orders? @relation(fields: [order_id], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "fk_logs_order")

  @@index([type], map: "idx_activity_type")
  @@index([timestamp(sort: Desc)], map: "idx_activity_timestamp")
  @@index([user_id], map: "idx_activity_user")
}

// ============================================================
// PANGKALAN CONSUMER MANAGEMENT (SAAS Multi-Tenant)
// ============================================================

/// Consumer/customer of a pangkalan (warung, ibu-ibu, etc.)
model consumers {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  pangkalan_id String   @db.Uuid
  name         String   @db.VarChar(255)
  phone        String?  @db.VarChar(20)
  address      String?
  note         String?
  is_active    Boolean  @default(true)
  created_at   DateTime @default(now()) @db.Timestamptz(6)
  updated_at   DateTime @default(now()) @db.Timestamptz(6)

  // Relations
  pangkalans       pangkalans         @relation(fields: [pangkalan_id], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "fk_consumers_pangkalan")
  consumer_orders  consumer_orders[]
  consumer_pricing consumer_pricing[]

  @@index([pangkalan_id], map: "idx_consumers_pangkalan")
  @@index([is_active], map: "idx_consumers_active")
}

/// Consumer order - sales from pangkalan to end consumers
model consumer_orders {
  id             String                  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  code           String                  @unique @db.VarChar(20) /// Display: PORD-0001
  pangkalan_id   String                  @db.Uuid
  consumer_id    String?                 @db.Uuid
  consumer_name  String?                 @db.VarChar(255) /// For walk-in customers
  lpg_type       lpg_type
  qty            Int
  price_per_unit Decimal                 @db.Decimal(15, 2)
  cost_price     Decimal                 @default(0) @db.Decimal(15, 2) /// Harga beli/modal per unit
  total_amount   Decimal                 @db.Decimal(15, 2)
  payment_status consumer_payment_status @default(LUNAS)
  note           String?
  sale_date      DateTime                @default(now()) @db.Timestamptz(6)
  created_at     DateTime                @default(now()) @db.Timestamptz(6)
  updated_at     DateTime                @default(now()) @db.Timestamptz(6)

  // Relations
  pangkalans pangkalans @relation(fields: [pangkalan_id], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "fk_consumer_orders_pangkalan")
  consumers  consumers? @relation(fields: [consumer_id], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "fk_consumer_orders_consumer")

  @@index([pangkalan_id], map: "idx_consumer_orders_pangkalan")
  @@index([consumer_id], map: "idx_consumer_orders_consumer")
  @@index([sale_date(sort: Desc)], map: "idx_consumer_orders_date")
  @@index([payment_status], map: "idx_consumer_orders_status")
}

// ============================================================
// ENUMS
// ============================================================

/// User role for access control
enum user_role {
  ADMIN /// Full access
  OPERATOR /// Limited access
  PANGKALAN /// Pangkalan owner - access to own data only
}

/// LPG product category
enum lpg_category {
  SUBSIDI /// Government subsidized (3kg hijau)
  NON_SUBSIDI /// Commercial (12kg, 50kg)
}

/// @deprecated - Legacy LPG type enum, use lpg_products instead
enum lpg_type {
  kg3  @map("3kg")
  kg5  @map("5.5kg")
  kg12 @map("12kg")
  kg50 @map("50kg")
}

/// Order status workflow
enum status_pesanan {
  DRAFT /// Newly created
  MENUNGGU_PEMBAYARAN /// Awaiting payment
  DIPROSES /// Being processed
  SIAP_KIRIM /// Ready for delivery
  DIKIRIM /// Out for delivery
  SELESAI /// Completed
  BATAL /// Cancelled
}

/// Payment method options
enum payment_method {
  TUNAI /// Cash
  TRANSFER /// Bank transfer
}

/// Stock movement direction
enum stock_movement_type {
  MASUK /// Stock in
  KELUAR /// Stock out
}

/// Consumer payment status
enum consumer_payment_status {
  LUNAS /// Paid in full
  HUTANG /// Credit/debt - not yet paid
}
