generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  extensions = [uuid_ossp(map: "uuid-ossp"), pgcrypto]
}

model activity_logs {
  id             String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id        String?         @db.Uuid
  order_id       String?         @db.Uuid
  type           String          @db.VarChar(50)
  title          String          @db.VarChar(255)
  description    String?
  pangkalan_name String?         @db.VarChar(255)
  detail_numeric Decimal?        @db.Decimal(15, 2)
  icon_name      String?         @db.VarChar(50)
  order_status   status_pesanan?
  timestamp      DateTime        @default(now()) @db.Timestamptz(6)
  created_at     DateTime        @default(now()) @db.Timestamptz(6)
  orders         orders?         @relation(fields: [order_id], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "fk_logs_order")
  users          users?          @relation(fields: [user_id], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "fk_logs_user")

  @@index([timestamp(sort: Desc)], map: "idx_activity_timestamp")
  @@index([type], map: "idx_activity_type")
}

model drivers {
  id         String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  code       String    @unique @db.VarChar(20)  // DRV-001 format for display
  name       String    @db.VarChar(255)
  phone      String?   @db.VarChar(20)
  vehicle_id String?   @db.VarChar(20)
  is_active  Boolean   @default(true)
  note       String?
  created_at DateTime  @default(now()) @db.Timestamptz(6)
  updated_at DateTime  @default(now()) @db.Timestamptz(6)
  deleted_at DateTime? @db.Timestamptz(6)
  orders     orders[]
}

model invoices {
  id              String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  order_id        String            @db.Uuid
  invoice_number  String?           @unique @db.VarChar(50)
  invoice_date    DateTime          @default(dbgenerated("CURRENT_DATE")) @db.Date
  due_date        DateTime?         @db.Date
  billing_address String?
  billed_to_name  String?           @db.VarChar(255)
  sub_total       Decimal           @db.Decimal(15, 2)
  tax_rate        Decimal?          @default(0) @db.Decimal(5, 2)
  tax_amount      Decimal?          @default(0) @db.Decimal(15, 2)
  grand_total     Decimal           @db.Decimal(15, 2)
  payment_status  String?           @default("UNPAID") @db.VarChar(50)
  created_at      DateTime          @default(now()) @db.Timestamptz(6)
  updated_at      DateTime          @default(now()) @db.Timestamptz(6)
  deleted_at      DateTime?         @db.Timestamptz(6)
  orders          orders            @relation(fields: [order_id], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "fk_invoices_order")
  payment_records payment_records[]
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model order_items {
  id             String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  order_id       String   @db.Uuid
  lpg_type       lpg_type
  label          String?  @db.VarChar(50)
  price_per_unit Decimal  @db.Decimal(15, 2)
  qty            Int
  sub_total      Decimal? @db.Decimal(15, 2)
  is_taxable     Boolean  @default(false)  // true jika NON_SUBSIDI (kena PPN 12%)
  tax_amount     Decimal  @default(0) @db.Decimal(15, 2)  // PPN per item
  created_at     DateTime @default(now()) @db.Timestamptz(6)
  updated_at     DateTime @default(now()) @db.Timestamptz(6)
  orders         orders   @relation(fields: [order_id], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "fk_order_items_order")

  @@index([order_id], map: "idx_order_items_order")
}

model order_payment_details {
  id             String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  order_id       String          @unique @db.Uuid
  is_paid        Boolean         @default(false)
  is_dp          Boolean         @default(false)
  payment_method payment_method?
  amount_paid    Decimal?        @default(0) @db.Decimal(15, 2)
  payment_date   DateTime?       @db.Timestamptz(6)
  proof_url      String?
  created_at     DateTime        @default(now()) @db.Timestamptz(6)
  updated_at     DateTime        @default(now()) @db.Timestamptz(6)
  orders         orders          @relation(fields: [order_id], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "fk_payment_details_order")
}

model orders {
  id                    String                 @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  code                  String                 @unique @db.VarChar(20)  // ORD-0001 format for display
  pangkalan_id          String                 @db.Uuid
  driver_id             String?                @db.Uuid
  order_date            DateTime               @default(dbgenerated("CURRENT_DATE")) @db.Date
  current_status        status_pesanan         @default(DRAFT)
  subtotal              Decimal                @default(0) @db.Decimal(15, 2)  // Total sebelum pajak
  tax_amount            Decimal                @default(0) @db.Decimal(15, 2)  // Total PPN (12% dari non-subsidi)
  total_amount          Decimal                @default(0) @db.Decimal(15, 2)  // Subtotal + Tax
  note                  String?
  created_at            DateTime               @default(now()) @db.Timestamptz(6)
  updated_at            DateTime               @default(now()) @db.Timestamptz(6)
  deleted_at            DateTime?              @db.Timestamptz(6)
  activity_logs         activity_logs[]
  invoices              invoices[]
  order_items           order_items[]
  order_payment_details order_payment_details?
  drivers               drivers?               @relation(fields: [driver_id], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "fk_orders_driver")
  pangkalans            pangkalans             @relation(fields: [pangkalan_id], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "fk_orders_pangkalan")
  payment_records       payment_records[]
  timeline_tracks       timeline_tracks[]
}

model pangkalans {
  id         String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  code       String    @unique @db.VarChar(20)  // PKL-001 format for display
  name       String    @db.VarChar(255)
  address    String
  region     String?   @db.VarChar(100)
  pic_name   String?   @db.VarChar(255)
  phone      String?   @db.VarChar(20)
  email      String?   @db.VarChar(255)  // Email untuk kirim invoice/dokumen
  capacity   Int?
  note       String?
  is_active  Boolean   @default(true)
  created_at DateTime  @default(now()) @db.Timestamptz(6)
  updated_at DateTime  @default(now()) @db.Timestamptz(6)
  deleted_at DateTime? @db.Timestamptz(6)
  orders     orders[]
}

model payment_records {
  id                  String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  order_id            String?        @db.Uuid
  invoice_id          String?        @db.Uuid
  method              payment_method
  amount              Decimal        @db.Decimal(15, 2)
  payment_time        DateTime       @default(now()) @db.Timestamptz(6)
  proof_url           String?
  recorded_by_user_id String         @db.Uuid
  note                String?
  created_at          DateTime       @default(now()) @db.Timestamptz(6)
  invoices            invoices?      @relation(fields: [invoice_id], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "fk_records_invoice")
  orders              orders?        @relation(fields: [order_id], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "fk_records_order")
  users               users          @relation(fields: [recorded_by_user_id], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "fk_records_user")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model stock_histories {
  id                  String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  lpg_type            lpg_type?           // Keep for backward compatibility
  lpg_product_id      String?             @db.Uuid // New: reference to dynamic product
  movement_type       stock_movement_type
  qty                 Int
  note                String?
  recorded_by_user_id String?             @db.Uuid
  timestamp           DateTime            @default(now()) @db.Timestamptz(6)
  created_at          DateTime            @default(now()) @db.Timestamptz(6)
  users               users?              @relation(fields: [recorded_by_user_id], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "fk_stock_user")
  lpg_product         lpg_products?       @relation(fields: [lpg_product_id], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "fk_stock_lpg_product")

  @@index([timestamp(sort: Desc)], map: "idx_stock_timestamp")
  @@index([lpg_type], map: "idx_stock_type")
  @@index([lpg_product_id], map: "idx_stock_product")
}

// Dynamic LPG Products Management
model lpg_products {
  id              String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name            String            @db.VarChar(100)
  size_kg         Decimal           @db.Decimal(5, 2) // e.g., 3.00, 5.50, 12.00, 50.00
  category        lpg_category      @default(NON_SUBSIDI)
  color           String?           @db.VarChar(50) // e.g., "hijau", "biru", "pink"
  description     String?
  selling_price   Decimal           @default(0) @db.Decimal(15, 2)  // Harga jual default
  cost_price      Decimal?          @db.Decimal(15, 2)              // Harga beli (untuk profit)
  is_active       Boolean           @default(true)
  created_at      DateTime          @default(now()) @db.Timestamptz(6)
  updated_at      DateTime          @default(now()) @db.Timestamptz(6)
  deleted_at      DateTime?         @db.Timestamptz(6)
  prices          lpg_prices[]      // Keep for backward compat, akan di-deprecate
  stock_histories stock_histories[]

  @@index([category], map: "idx_lpg_products_category")
  @@index([is_active], map: "idx_lpg_products_active")
}

// Multiple prices per product (e.g., retail, wholesale, different brands)
model lpg_prices {
  id             String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  lpg_product_id String       @db.Uuid
  label          String       @db.VarChar(100) // e.g., "Harga Retail", "Harga Grosir"
  price          Decimal      @db.Decimal(15, 2)  // Harga jual
  cost_price     Decimal?     @db.Decimal(15, 2)  // Harga beli (untuk hitung profit)
  is_default     Boolean      @default(false)
  created_at     DateTime     @default(now()) @db.Timestamptz(6)
  updated_at     DateTime     @default(now()) @db.Timestamptz(6)
  lpg_product    lpg_products @relation(fields: [lpg_product_id], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "fk_prices_product")

  @@index([lpg_product_id], map: "idx_lpg_prices_product")
}

model timeline_tracks {
  id          String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  order_id    String         @db.Uuid
  status      status_pesanan
  description String?
  note        String?
  created_at  DateTime       @default(now()) @db.Timestamptz(6)
  orders      orders         @relation(fields: [order_id], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "fk_timeline_orders")

  @@index([order_id, created_at(sort: Desc)], map: "idx_timeline_created")
  @@index([order_id], map: "idx_timeline_order")
}

model users {
  id              String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  code            String            @unique @db.VarChar(20)  // USR-001 format for display
  email           String            @unique @db.VarChar(255)
  password        String            @db.VarChar(255)
  role            user_role         @default(OPERATOR)
  is_active       Boolean           @default(true)
  name            String            @db.VarChar(255)
  phone           String?           @db.VarChar(20)
  avatar_url      String?
  created_at      DateTime          @default(now()) @db.Timestamptz(6)
  updated_at      DateTime          @default(now()) @db.Timestamptz(6)
  deleted_at      DateTime?         @db.Timestamptz(6)
  activity_logs   activity_logs[]
  payment_records payment_records[]
  stock_histories stock_histories[]
}

enum lpg_type {
  kg3  @map("3kg")
  kg12 @map("12kg")
  kg50 @map("50kg")
}

enum payment_method {
  TUNAI
  TRANSFER
}

enum status_pesanan {
  DRAFT
  MENUNGGU_PEMBAYARAN
  DIPROSES
  SIAP_KIRIM
  DIKIRIM
  SELESAI
  BATAL
}

enum stock_movement_type {
  MASUK
  KELUAR
}

enum user_role {
  ADMIN
  OPERATOR
}

enum lpg_category {
  SUBSIDI
  NON_SUBSIDI
}
