import{j as jsxRuntimeExports}from"./jsx-runtime.mvtouYz0.js";import{r as reactExports}from"./index.DcciWILN.js";import{C as Card,a as CardContent}from"./card.D0gylVsf.js";import{S as SafeIcon,B as Button}from"./SafeIcon.CAGsavDo.js";import{I as Input}from"./input.C9ryBhC0.js";import{L as Label}from"./label.BFF1cpbq.js";import{B as Badge}from"./badge.DZiJ6zSB.js";import{consumersApi,lpgPricesApi,consumerOrdersApi}from"./api.Dr7hS9Y8.js";import{t as toast}from"./index.fAd_ikgp.js";import"./index.PIAPtHoh.js";import"./index.ubNQCTBn.js";const LPG_DISPLAY=[{value:"3kg",dbType:"kg3",display:"3 kg",color:"#22C55E",bgClass:"from-green-500 to-emerald-600",defaultPrice:2e4},{value:"5kg",dbType:"kg5",display:"5.5 kg",color:"#ff82c5",bgClass:"from-pink-400 to-pink-600",defaultPrice:6e4},{value:"12kg",dbType:"kg12",display:"12 kg",color:"#3B82F6",bgClass:"from-blue-500 to-indigo-600",defaultPrice:18e4},{value:"50kg",dbType:"kg50",display:"50 kg",color:"#ef0e0e",bgClass:"from-red-500 to-red-600",defaultPrice:7e5}];function CatatPenjualanPage(){const[lpgType,setLpgType]=reactExports.useState("3kg"),[qty,setQty]=reactExports.useState(1),[selectedConsumer,setSelectedConsumer]=reactExports.useState(null),[consumerSearch,setConsumerSearch]=reactExports.useState(""),[consumers,setConsumers]=reactExports.useState([]),[showDropdown,setShowDropdown]=reactExports.useState(!1),[paymentStatus,setPaymentStatus]=reactExports.useState("LUNAS"),[isSubmitting,setIsSubmitting]=reactExports.useState(!1),[showSuccess,setShowSuccess]=reactExports.useState(!1),[isLoading,setIsLoading]=reactExports.useState(!1),[lpgPrices,setLpgPrices]=reactExports.useState([]),[manualPrice,setManualPrice]=reactExports.useState(null),dropdownRef=reactExports.useRef(null),holdIntervalRef=reactExports.useRef(null),holdTimeoutRef=reactExports.useRef(null);reactExports.useEffect(()=>{(async()=>{try{const prices=await lpgPricesApi.getAll();setLpgPrices(prices)}catch(error){console.error("Failed to fetch LPG prices:",error)}})()},[]);const getPrice=type=>{const displayItem=LPG_DISPLAY.find(l=>l.value===type);if(!displayItem)return 2e4;const priceFromDb=lpgPrices.find(p=>p.lpg_type===displayItem.dbType);return priceFromDb?Number(priceFromDb.selling_price):displayItem.defaultPrice},isLpgActive=type=>{const displayItem=LPG_DISPLAY.find(l=>l.value===type);if(!displayItem)return!1;const priceFromDb=lpgPrices.find(p=>p.lpg_type===displayItem.dbType);return priceFromDb?priceFromDb.is_active:!0},activeLpgTypes=LPG_DISPLAY.filter(lpg=>isLpgActive(lpg.value));reactExports.useEffect(()=>{lpgPrices.length>0&&activeLpgTypes.length>0&&(isLpgActive(lpgType)||setLpgType(activeLpgTypes[0].value))},[lpgPrices]);const selectedLpg=LPG_DISPLAY.find(l=>l.value===lpgType),defaultPrice=getPrice(lpgType),currentPrice=manualPrice!==null?manualPrice:defaultPrice,total=qty*currentPrice;reactExports.useEffect(()=>{setManualPrice(null)},[lpgType]);const formatCurrency=v=>new Intl.NumberFormat("id-ID",{style:"currency",currency:"IDR",minimumFractionDigits:0}).format(v),startHold=reactExports.useCallback(action=>{holdTimeoutRef.current=setTimeout(()=>{holdIntervalRef.current=setInterval(()=>{setQty(action==="inc"?prev=>prev+1:prev=>Math.max(1,prev-1))},80)},300)},[]),stopHold=reactExports.useCallback(()=>{holdTimeoutRef.current&&clearTimeout(holdTimeoutRef.current),holdIntervalRef.current&&clearInterval(holdIntervalRef.current)},[]);reactExports.useEffect(()=>()=>stopHold(),[stopHold]),reactExports.useEffect(()=>{const timer=setTimeout(async()=>{try{setIsLoading(!0);const res=await consumersApi.getAll(1,10,consumerSearch||void 0);setConsumers(res.data)}catch(e){console.error(e)}finally{setIsLoading(!1)}},300);return()=>clearTimeout(timer)},[consumerSearch]),reactExports.useEffect(()=>{const handler=e=>{dropdownRef.current&&!dropdownRef.current.contains(e.target)&&setShowDropdown(!1)};return document.addEventListener("mousedown",handler),()=>document.removeEventListener("mousedown",handler)},[]);const handleSubmit=async e=>{if(e.preventDefault(),qty<1)return toast.error("Jumlah minimal 1");try{setIsSubmitting(!0),await consumerOrdersApi.create({consumer_id:selectedConsumer?.id,consumer_name:selectedConsumer?.name||consumerSearch||"Walk-in",lpg_type:lpgType,qty,price_per_unit:currentPrice,payment_status:paymentStatus}),setShowSuccess(!0),toast.success("Penjualan berhasil!"),setTimeout(()=>{setShowSuccess(!1),setQty(1),setSelectedConsumer(null),setConsumerSearch("")},2e3)}catch(err){toast.error(err.message||"Gagal menyimpan")}finally{setIsSubmitting(!1)}};return showSuccess?jsxRuntimeExports.jsx("div",{className:"flex items-center justify-center min-h-[50vh]",children:jsxRuntimeExports.jsxs("div",{className:"text-center",children:[jsxRuntimeExports.jsx("div",{className:"w-16 h-16 mx-auto mb-3 rounded-full bg-green-500 flex items-center justify-center shadow-lg",children:jsxRuntimeExports.jsx(SafeIcon,{name:"Check",className:"h-8 w-8 text-white"})}),jsxRuntimeExports.jsx("h2",{className:"text-xl font-bold mb-1",children:"Berhasil!"}),jsxRuntimeExports.jsxs("p",{className:"text-slate-500 mb-4",children:[qty,"× ",selectedLpg.display," = ",formatCurrency(total)]}),jsxRuntimeExports.jsxs(Button,{onClick:()=>setShowSuccess(!1),className:"rounded-xl",children:[jsxRuntimeExports.jsx(SafeIcon,{name:"Plus",className:"h-4 w-4 mr-1"})," Catat Lagi"]})]})}):jsxRuntimeExports.jsxs("div",{className:"space-y-6",children:[jsxRuntimeExports.jsxs("div",{className:"flex items-center justify-between",children:[jsxRuntimeExports.jsx("h1",{className:"text-2xl font-bold text-slate-900",children:"Catat Penjualan"}),jsxRuntimeExports.jsxs(Button,{variant:"outline",size:"sm",className:"rounded-xl",onClick:()=>window.location.href="/pangkalan/penjualan",children:[jsxRuntimeExports.jsx(SafeIcon,{name:"History",className:"h-4 w-4 mr-1"})," Riwayat"]})]}),jsxRuntimeExports.jsx("form",{onSubmit:handleSubmit,children:jsxRuntimeExports.jsxs("div",{className:"grid lg:grid-cols-2 gap-6",children:[jsxRuntimeExports.jsx(Card,{className:"shadow-lg border-0 rounded-2xl",children:jsxRuntimeExports.jsxs(CardContent,{className:"p-5 space-y-5",children:[jsxRuntimeExports.jsxs("div",{children:[jsxRuntimeExports.jsx(Label,{className:"text-sm font-semibold text-slate-700 mb-3 block",children:"Tipe LPG"}),jsxRuntimeExports.jsx("div",{className:"grid grid-cols-2 gap-2",children:activeLpgTypes.map(lpg=>jsxRuntimeExports.jsxs("button",{type:"button",onClick:()=>setLpgType(lpg.value),className:`relative p-3 rounded-xl border-2 text-left transition-all ${lpgType===lpg.value?"border-transparent bg-gradient-to-br "+lpg.bgClass+" shadow-lg":"border-slate-200 bg-white hover:border-slate-300 hover:shadow"}`,children:[jsxRuntimeExports.jsxs("div",{className:"flex items-center gap-3",children:[jsxRuntimeExports.jsx("div",{className:`w-10 h-10 rounded-lg flex items-center justify-center ${lpgType===lpg.value?"bg-white/20":""}`,style:{backgroundColor:lpgType!==lpg.value?lpg.color+"20":void 0},children:jsxRuntimeExports.jsx(SafeIcon,{name:"Cylinder",className:`h-5 w-5 ${lpgType===lpg.value?"text-white":""}`,style:{color:lpgType!==lpg.value?lpg.color:void 0}})}),jsxRuntimeExports.jsxs("div",{children:[jsxRuntimeExports.jsx("span",{className:`font-bold block ${lpgType===lpg.value?"text-white":"text-slate-900"}`,children:lpg.display}),jsxRuntimeExports.jsx("span",{className:`text-xs ${lpgType===lpg.value?"text-white/80":"text-slate-500"}`,children:formatCurrency(getPrice(lpg.value))})]})]}),lpgType===lpg.value&&jsxRuntimeExports.jsx(SafeIcon,{name:"Check",className:"absolute top-2 right-2 h-4 w-4 text-white"})]},lpg.value))})]}),jsxRuntimeExports.jsxs("div",{children:[jsxRuntimeExports.jsx(Label,{className:"text-sm font-semibold text-slate-700 mb-3 block",children:"Jumlah"}),jsxRuntimeExports.jsxs("div",{className:"flex items-center gap-3",children:[jsxRuntimeExports.jsx(Button,{type:"button",variant:"outline",className:"h-12 w-12 text-lg font-bold rounded-xl",onClick:()=>setQty(Math.max(0,qty-1)),onMouseDown:()=>startHold("dec"),onMouseUp:stopHold,onMouseLeave:stopHold,onTouchStart:()=>startHold("dec"),onTouchEnd:stopHold,disabled:qty<=0,children:"−"}),jsxRuntimeExports.jsx(Input,{type:"text",inputMode:"numeric",value:qty===0?"":qty.toString(),onChange:e=>{const val=e.target.value.replace(/^0+/,"").replace(/\D/g,"");setQty(val===""?0:parseInt(val))},placeholder:"0",className:"h-12 text-center font-bold text-xl flex-1 rounded-xl"}),jsxRuntimeExports.jsx(Button,{type:"button",variant:"outline",className:"h-12 w-12 text-lg font-bold rounded-xl",onClick:()=>setQty(qty+1),onMouseDown:()=>startHold("inc"),onMouseUp:stopHold,onMouseLeave:stopHold,onTouchStart:()=>startHold("inc"),onTouchEnd:stopHold,children:"+"})]})]}),jsxRuntimeExports.jsxs("div",{children:[jsxRuntimeExports.jsxs(Label,{className:"text-sm font-semibold text-slate-700 mb-3 flex items-center justify-between",children:[jsxRuntimeExports.jsx("span",{children:"Harga Jual"}),manualPrice==null&&jsxRuntimeExports.jsx("button",{type:"button",onClick:()=>setManualPrice(null),className:"text-xs text-blue-600 hover:text-blue-700 font-medium",children:"Reset ke default"})]}),jsxRuntimeExports.jsxs("div",{className:"relative",children:[jsxRuntimeExports.jsx("span",{className:"absolute left-3 top-1/2 -translate-y-1/2 text-slate-500 font-medium",children:"Rp"}),jsxRuntimeExports.jsx(Input,{type:"text",inputMode:"numeric",value:manualPrice===null?defaultPrice.toLocaleString("id-ID"):manualPrice===0?"":manualPrice.toLocaleString("id-ID"),onChange:e=>{const val=e.target.value.replace(/\D/g,"");setManualPrice(val===""?0:parseInt(val))},onBlur:()=>{manualPrice===0&&setManualPrice(null)},placeholder:defaultPrice.toLocaleString("id-ID"),className:"h-12 pl-10 text-lg font-bold rounded-xl placeholder:text-slate-300 placeholder:font-normal"}),manualPrice!==null&&manualPrice!==0&&manualPrice!==defaultPrice&&jsxRuntimeExports.jsx(Badge,{className:"absolute right-3 top-1/2 -translate-y-1/2 bg-orange-100 text-orange-700",children:"Custom"})]}),jsxRuntimeExports.jsxs("p",{className:"text-xs text-slate-500 mt-1",children:["Default: ",formatCurrency(defaultPrice)]})]}),jsxRuntimeExports.jsxs("div",{ref:dropdownRef,className:"relative",children:[jsxRuntimeExports.jsxs(Label,{className:"text-sm font-semibold text-slate-700 mb-3 flex items-center",children:["Konsumen ",jsxRuntimeExports.jsx(Badge,{variant:"secondary",className:"text-xs ml-2",children:"Opsional"})]}),jsxRuntimeExports.jsxs("div",{className:"relative",children:[jsxRuntimeExports.jsx(SafeIcon,{name:"Search",className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-slate-400"}),jsxRuntimeExports.jsx(Input,{value:consumerSearch,onChange:e=>{setConsumerSearch(e.target.value),setSelectedConsumer(null),setShowDropdown(!0)},onFocus:()=>setShowDropdown(!0),placeholder:"Cari konsumen...",className:"h-12 pl-10 rounded-xl"}),selectedConsumer&&jsxRuntimeExports.jsx(SafeIcon,{name:"CheckCircle2",className:"absolute right-3 top-1/2 -translate-y-1/2 h-5 w-5 text-green-500"})]}),showDropdown&&jsxRuntimeExports.jsx("div",{className:"absolute z-50 w-full mt-2 bg-white rounded-xl shadow-2xl border border-slate-200 max-h-48 overflow-y-auto",children:isLoading?jsxRuntimeExports.jsxs("div",{className:"p-4 text-center text-slate-500 text-sm",children:[jsxRuntimeExports.jsx(SafeIcon,{name:"Loader2",className:"h-4 w-4 animate-spin inline mr-2"})," Memuat..."]}):consumers.length>0?consumers.map(c=>jsxRuntimeExports.jsxs("button",{type:"button",onClick:()=>{setSelectedConsumer(c),setConsumerSearch(c.name),setShowDropdown(!1)},className:"w-full px-4 py-3 text-left hover:bg-blue-50 flex items-center gap-3 border-b border-slate-100 last:border-0 transition-colors",children:[jsxRuntimeExports.jsx("div",{className:"w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center shrink-0",children:jsxRuntimeExports.jsx(SafeIcon,{name:"User",className:"h-5 w-5 text-blue-600"})}),jsxRuntimeExports.jsxs("div",{className:"flex-1 min-w-0",children:[jsxRuntimeExports.jsx("p",{className:"font-semibold text-slate-900 truncate",children:c.name}),jsxRuntimeExports.jsx("p",{className:"text-xs text-slate-500 truncate",children:c.nik?`NIK: ${c.nik}`:c.phone||"Konsumen terdaftar"})]})]},c.id)):jsxRuntimeExports.jsx("div",{className:"p-4 text-center text-slate-500 text-sm",children:consumerSearch?`"${consumerSearch}" = Walk-in`:"Ketik untuk mencari..."})})]})]})}),jsxRuntimeExports.jsx(Card,{className:"shadow-lg border-0 rounded-2xl",children:jsxRuntimeExports.jsxs(CardContent,{className:"p-5 space-y-5",children:[jsxRuntimeExports.jsxs("div",{children:[jsxRuntimeExports.jsx(Label,{className:"text-sm font-semibold text-slate-700 mb-3 block",children:"Status Pembayaran"}),jsxRuntimeExports.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[jsxRuntimeExports.jsxs("button",{type:"button",onClick:()=>setPaymentStatus("LUNAS"),className:`p-4 rounded-xl border-2 flex items-center justify-center gap-2 transition-all ${paymentStatus==="LUNAS"?"border-green-500 bg-green-50 shadow-md":"border-slate-200 hover:border-slate-300"}`,children:[jsxRuntimeExports.jsx(SafeIcon,{name:"CheckCircle",className:`h-5 w-5 ${paymentStatus==="LUNAS"?"text-green-600":"text-slate-400"}`}),jsxRuntimeExports.jsx("span",{className:`font-semibold ${paymentStatus==="LUNAS"?"text-green-700":"text-slate-600"}`,children:"Lunas"})]}),jsxRuntimeExports.jsxs("button",{type:"button",onClick:()=>setPaymentStatus("HUTANG"),className:`p-4 rounded-xl border-2 flex items-center justify-center gap-2 transition-all ${paymentStatus==="HUTANG"?"border-orange-500 bg-orange-50 shadow-md":"border-slate-200 hover:border-slate-300"}`,children:[jsxRuntimeExports.jsx(SafeIcon,{name:"Clock",className:`h-5 w-5 ${paymentStatus==="HUTANG"?"text-orange-600":"text-slate-400"}`}),jsxRuntimeExports.jsx("span",{className:`font-semibold ${paymentStatus==="HUTANG"?"text-orange-700":"text-slate-600"}`,children:"Hutang"})]})]})]}),jsxRuntimeExports.jsxs("div",{className:"bg-gradient-to-br from-blue-600 to-indigo-700 rounded-2xl p-6 text-center text-white shadow-lg",children:[jsxRuntimeExports.jsx("p",{className:"text-blue-200 text-sm font-medium",children:"Total Pembayaran"}),jsxRuntimeExports.jsx("p",{className:"text-4xl font-bold my-2",children:formatCurrency(total)}),jsxRuntimeExports.jsxs("p",{className:"text-blue-200 text-sm",children:[qty," × ",selectedLpg.display," @ ",formatCurrency(currentPrice)]})]}),jsxRuntimeExports.jsx(Button,{type:"submit",disabled:isSubmitting||qty<1,className:"w-full h-14 bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-lg font-semibold rounded-xl shadow-lg disabled:opacity-50",children:isSubmitting?jsxRuntimeExports.jsxs(jsxRuntimeExports.Fragment,{children:[jsxRuntimeExports.jsx(SafeIcon,{name:"Loader2",className:"mr-2 h-5 w-5 animate-spin"})," Menyimpan..."]}):jsxRuntimeExports.jsxs(jsxRuntimeExports.Fragment,{children:[jsxRuntimeExports.jsx(SafeIcon,{name:"Save",className:"mr-2 h-5 w-5"})," Simpan Penjualan"]})})]})})]})})]})}export{CatatPenjualanPage as default};
