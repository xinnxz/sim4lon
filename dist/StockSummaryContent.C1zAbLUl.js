import{j as jsxRuntimeExports}from"./jsx-runtime.mvtouYz0.js";import{r as reactExports}from"./index.DcciWILN.js";import{C as Card,a as CardHeader,d as CardContent,b as CardTitle,c as CardDescription}from"./card.SxAweRZB.js";import{S as SafeIcon,B as Button}from"./SafeIcon.C08LGL0m.js";import{B as Badge}from"./badge.BFgaaq5n.js";import{I as Input}from"./input.B0jSBU-X.js";import{lpgProductsApi,stockApi,dashboardApi}from"./api.B5PpFILw.js";import{t as toast}from"./index.fAd_ikgp.js";import{R as ResponsiveContainer,T as Tooltip,L as Legend}from"./generateCategoricalChart.Crqe-OLF.js";import{L as LineChart,C as CartesianGrid,X as XAxis,Y as YAxis,a as Line}from"./LineChart.DBAKq2J_.js";import"./index.PIAPtHoh.js";import"./index.ubNQCTBn.js";const sizeToLpgType=sizeKg=>sizeKg===3?"3kg":sizeKg===12?"12kg":sizeKg===50?"50kg":"3kg",getStatusFromStock=(current,minStock)=>current<=minStock*.25?"critical":current<=minStock?"warning":"normal",getStatusBadge=status=>{switch(status){case"critical":return jsxRuntimeExports.jsx(Badge,{variant:"outline",className:"bg-destructive/10 text-destructive border-destructive/20",children:"Kritis"});case"warning":return jsxRuntimeExports.jsx(Badge,{variant:"outline",className:"bg-amber-500/10 text-amber-600 border-amber-500/20",children:"Peringatan"});default:return jsxRuntimeExports.jsx(Badge,{variant:"outline",className:"bg-green-500/10 text-green-600 border-green-500/20",children:"Normal"})}},getCategoryLabel=category=>category==="SUBSIDI"?"Subsidi":"Non-Subsidi",getColorHex=colorName=>colorName&&{hijau:"#22c55e",biru:"#38bdf8",ungu:"#a855f7",pink:"#ec4899",merah:"#dc2626",kuning:"#eab308",orange:"#f97316"}[colorName.toLowerCase()]||"#6b7280";function StockSummaryCards({refreshTrigger}){const[products,setProducts]=reactExports.useState([]),[isLoading,setIsLoading]=reactExports.useState(!0),[error,setError]=reactExports.useState(null),[editingCard,setEditingCard]=reactExports.useState(null),[editQuantity,setEditQuantity]=reactExports.useState(""),[isSubmitting,setIsSubmitting]=reactExports.useState(!1),holdTimeoutRef=reactExports.useRef(null),holdIntervalRef=reactExports.useRef(null),holdCountRef=reactExports.useRef(0),handleIncrement=reactExports.useCallback(()=>{setEditQuantity(prev=>String(parseInt(prev||"0")+1))},[]),handleDecrement=reactExports.useCallback(()=>{setEditQuantity(prev=>String(Math.max(0,parseInt(prev||"0")-1)))},[]),startHold=reactExports.useCallback(action=>{holdCountRef.current=0,holdTimeoutRef.current=setTimeout(()=>{const tick=()=>{holdCountRef.current++;let step=1;holdCountRef.current>30?step=10:holdCountRef.current>10&&(step=5),setEditQuantity(action==="increment"?prev=>String(parseInt(prev||"0")+step):prev=>String(Math.max(0,parseInt(prev||"0")-step)));let delay=100;holdCountRef.current>30?delay=50:holdCountRef.current>10&&(delay=75),holdIntervalRef.current=setTimeout(tick,delay)};tick()},250)},[]),stopHold=reactExports.useCallback(()=>{holdCountRef.current=0,holdTimeoutRef.current&&(clearTimeout(holdTimeoutRef.current),holdTimeoutRef.current=null),holdIntervalRef.current&&(clearTimeout(holdIntervalRef.current),holdIntervalRef.current=null)},[]);reactExports.useEffect(()=>()=>{stopHold()},[stopHold]);const fetchData=async()=>{try{setIsLoading(!0);const data=await lpgProductsApi.getWithStock();setProducts(data),setError(null)}catch(err){console.error("Failed to fetch products with stock:",err),setError("Gagal memuat data stok")}finally{setIsLoading(!1)}};reactExports.useEffect(()=>{fetchData()},[refreshTrigger]);const handleEdit=productId=>{setEditingCard(productId),setEditQuantity("")},handleCancelEdit=()=>{setEditingCard(null),setEditQuantity("")},handleSubmit=async(product,movementType)=>{const qty=parseInt(editQuantity);if(!qty||qty<=0){toast.error("Masukkan jumlah yang valid");return}if(movementType==="KELUAR"&&qty>product.stock.current){toast.error(`Stok tidak mencukupi. Stok saat ini: ${product.stock.current} unit`);return}setIsSubmitting(!0);try{const lpgType=sizeToLpgType(Number(product.size_kg));await stockApi.createMovement({lpg_product_id:product.id,lpg_type:lpgType,movement_type:movementType,qty}),toast.success(`${movementType==="MASUK"?"+":"-"}${qty} unit ${product.name} berhasil disimpan`),await fetchData(),handleCancelEdit()}catch(error2){console.error("Failed to create movement:",error2),toast.error(error2?.message||"Gagal menyimpan perubahan stok")}finally{setIsSubmitting(!1)}},formatPrice=price=>new Intl.NumberFormat("id-ID",{style:"currency",currency:"IDR",minimumFractionDigits:0}).format(price);return isLoading?jsxRuntimeExports.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4",children:[1,2,3,4].map(i=>jsxRuntimeExports.jsxs(Card,{className:"border-2 shadow-soft animate-pulse",children:[jsxRuntimeExports.jsxs(CardHeader,{className:"pb-3",children:[jsxRuntimeExports.jsx("div",{className:"h-6 bg-gray-200 rounded w-1/2"}),jsxRuntimeExports.jsx("div",{className:"h-4 bg-gray-100 rounded w-1/3 mt-2"})]}),jsxRuntimeExports.jsxs(CardContent,{className:"space-y-4",children:[jsxRuntimeExports.jsx("div",{className:"h-16 bg-gray-200 rounded w-1/2"}),jsxRuntimeExports.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[jsxRuntimeExports.jsx("div",{className:"h-12 bg-gray-100 rounded"}),jsxRuntimeExports.jsx("div",{className:"h-12 bg-gray-100 rounded"})]})]})]},i))}):error?jsxRuntimeExports.jsxs("div",{className:"p-6 text-center text-muted-foreground",children:[jsxRuntimeExports.jsx(SafeIcon,{name:"AlertCircle",className:"h-10 w-10 mx-auto mb-2 text-destructive"}),jsxRuntimeExports.jsx("p",{children:error}),jsxRuntimeExports.jsx("button",{onClick:fetchData,className:"mt-2 text-primary hover:underline",children:"Coba lagi"})]}):products.length===0?jsxRuntimeExports.jsx(Card,{className:"border-2 border-dashed",children:jsxRuntimeExports.jsxs(CardContent,{className:"p-12 text-center",children:[jsxRuntimeExports.jsx(SafeIcon,{name:"Package",className:"h-12 w-12 mx-auto mb-4 text-muted-foreground"}),jsxRuntimeExports.jsx("h3",{className:"text-lg font-semibold mb-2",children:"Belum Ada Produk LPG"}),jsxRuntimeExports.jsx("p",{className:"text-muted-foreground mb-4",children:"Tambahkan produk LPG terlebih dahulu untuk melihat stok."}),jsxRuntimeExports.jsxs(Button,{onClick:()=>window.location.href="/kelola-produk-lpg",children:[jsxRuntimeExports.jsx(SafeIcon,{name:"Plus",className:"h-4 w-4 mr-2"}),"Kelola Produk LPG"]})]})}):jsxRuntimeExports.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4",children:products.map((product,index)=>{const isEditing=editingCard===product.id,minStock=product.category==="SUBSIDI"?100:50,status=getStatusFromStock(product.stock.current,minStock),displayPrice=product.selling_price||product.prices?.find(p=>p.is_default)?.price||product.prices?.[0]?.price||0;return jsxRuntimeExports.jsx("div",{className:"animate-fadeInUp",style:{animationDelay:`${.1+index*.05}s`},children:jsxRuntimeExports.jsxs(Card,{className:`border shadow-soft hover:shadow-card transition-all duration-300 overflow-hidden ${isEditing?"ring-2 ring-primary":""}`,style:{borderLeftWidth:"4px",borderLeftColor:getColorHex(product.color)},children:[jsxRuntimeExports.jsx(CardHeader,{className:"pb-2",children:jsxRuntimeExports.jsxs("div",{className:"flex items-start justify-between gap-2",children:[jsxRuntimeExports.jsxs("div",{className:"flex-1 min-w-0",children:[jsxRuntimeExports.jsx(CardTitle,{className:"text-base font-bold truncate",children:product.name}),jsxRuntimeExports.jsxs("div",{className:"text-muted-foreground text-xs",children:[product.size_kg," kg"]})]}),jsxRuntimeExports.jsx("div",{className:"flex h-10 w-10 shrink-0 items-center justify-center rounded-lg bg-muted/50",children:jsxRuntimeExports.jsx(SafeIcon,{name:"Cylinder",className:"h-5 w-5 text-muted-foreground"})})]})}),jsxRuntimeExports.jsxs(CardContent,{className:"space-y-3",children:[jsxRuntimeExports.jsxs("div",{className:"text-center py-2",children:[jsxRuntimeExports.jsx("span",{className:`text-4xl font-bold ${product.stock.current<0?"text-destructive":"text-foreground"}`,children:product.stock.current}),jsxRuntimeExports.jsx("span",{className:"text-lg text-muted-foreground ml-2",children:"unit"})]}),jsxRuntimeExports.jsxs("div",{className:"flex justify-between items-center text-xs",children:[jsxRuntimeExports.jsx(Badge,{variant:"outline",className:"text-muted-foreground",children:getCategoryLabel(product.category)}),displayPrice>0&&jsxRuntimeExports.jsx("span",{className:"font-semibold",children:formatPrice(Number(displayPrice))})]}),isEditing?jsxRuntimeExports.jsxs("div",{className:"space-y-3 pt-2 border-t",children:[jsxRuntimeExports.jsxs("div",{children:[jsxRuntimeExports.jsx("label",{className:"text-xs font-medium text-muted-foreground",children:"Jumlah"}),jsxRuntimeExports.jsxs("div",{className:"flex items-center gap-1",children:[jsxRuntimeExports.jsx(Button,{type:"button",variant:"outline",size:"sm",className:"h-10 w-10 p-0 select-none",onClick:handleDecrement,onMouseDown:()=>startHold("decrement"),onMouseUp:stopHold,onMouseLeave:stopHold,onTouchStart:()=>startHold("decrement"),onTouchEnd:stopHold,disabled:!editQuantity||parseInt(editQuantity)<=0,children:jsxRuntimeExports.jsx(SafeIcon,{name:"Minus",className:"h-4 w-4"})}),jsxRuntimeExports.jsx(Input,{type:"text",inputMode:"numeric",pattern:"[0-9]*",value:editQuantity,onChange:e=>{const val=e.target.value.replace(/\D/g,"");setEditQuantity(val)},onWheel:e=>e.currentTarget.blur(),placeholder:"0",className:"h-10 text-center text-lg font-semibold flex-1",autoFocus:!0}),jsxRuntimeExports.jsx(Button,{type:"button",variant:"outline",size:"sm",className:"h-10 w-10 p-0 select-none",onClick:handleIncrement,onMouseDown:()=>startHold("increment"),onMouseUp:stopHold,onMouseLeave:stopHold,onTouchStart:()=>startHold("increment"),onTouchEnd:stopHold,children:jsxRuntimeExports.jsx(SafeIcon,{name:"Plus",className:"h-4 w-4"})})]})]}),jsxRuntimeExports.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[jsxRuntimeExports.jsx(Button,{size:"sm",className:"bg-red-600 hover:bg-red-700 text-white",onClick:()=>handleSubmit(product,"KELUAR"),disabled:isSubmitting||!editQuantity,children:isSubmitting?jsxRuntimeExports.jsx(SafeIcon,{name:"Loader2",className:"h-4 w-4 animate-spin"}):jsxRuntimeExports.jsxs(jsxRuntimeExports.Fragment,{children:[jsxRuntimeExports.jsx(SafeIcon,{name:"Minus",className:"h-4 w-4 mr-1"}),"Keluar"]})}),jsxRuntimeExports.jsx(Button,{size:"sm",className:"bg-green-600 hover:bg-green-700 text-white",onClick:()=>handleSubmit(product,"MASUK"),disabled:isSubmitting||!editQuantity,children:isSubmitting?jsxRuntimeExports.jsx(SafeIcon,{name:"Loader2",className:"h-4 w-4 animate-spin"}):jsxRuntimeExports.jsxs(jsxRuntimeExports.Fragment,{children:[jsxRuntimeExports.jsx(SafeIcon,{name:"Plus",className:"h-4 w-4 mr-1"}),"Masuk"]})})]}),jsxRuntimeExports.jsx(Button,{variant:"ghost",size:"sm",className:"w-full text-muted-foreground",onClick:handleCancelEdit,disabled:isSubmitting,children:"Batal"})]}):jsxRuntimeExports.jsxs("div",{className:"flex justify-between items-center pt-2 border-t",children:[getStatusBadge(status),jsxRuntimeExports.jsxs(Button,{variant:"outline",size:"sm",className:"text-xs",onClick:()=>handleEdit(product.id),children:[jsxRuntimeExports.jsx(SafeIcon,{name:"Pencil",className:"h-3 w-3 mr-1"}),"Edit"]})]})]})]})},product.id)})})}const CustomTooltip=({active,payload,label})=>active&&payload&&payload.length?jsxRuntimeExports.jsxs("div",{className:"bg-background border border-border rounded-lg shadow-lg p-3 backdrop-blur-sm",children:[jsxRuntimeExports.jsx("p",{className:"text-sm font-semibold text-foreground mb-2",children:label}),payload.map((entry,index)=>jsxRuntimeExports.jsxs("p",{className:"text-sm",style:{color:entry.color},children:[entry.name,": ",jsxRuntimeExports.jsxs("span",{className:"font-bold",children:[entry.value," tabung"]})]},index))]}):null;function StockConsumptionChart({refreshTrigger}){const[chartData,setChartData]=reactExports.useState(null),[isLoading,setIsLoading]=reactExports.useState(!0),[error,setError]=reactExports.useState(null);return reactExports.useEffect(()=>{(async()=>{try{setIsLoading(!0);const response=await dashboardApi.getStockChart();setChartData(response),setError(null)}catch(err){console.error("Failed to fetch stock consumption chart:",err),setError("Gagal memuat data"),setChartData(null)}finally{setIsLoading(!1)}})()},[refreshTrigger]),isLoading?jsxRuntimeExports.jsx("div",{className:"w-full h-48 flex items-center justify-center",children:jsxRuntimeExports.jsx("div",{className:"animate-pulse text-muted-foreground text-sm",children:"Memuat data..."})}):error?jsxRuntimeExports.jsx("div",{className:"w-full h-48 flex items-center justify-center",children:jsxRuntimeExports.jsx("div",{className:"text-destructive text-sm",children:error})}):!chartData||chartData.data.length===0||chartData.products.length===0?jsxRuntimeExports.jsx("div",{className:"w-full h-48 flex items-center justify-center",children:jsxRuntimeExports.jsx("div",{className:"text-muted-foreground text-sm",children:"Belum ada data pemakaian stok"})}):jsxRuntimeExports.jsx("div",{className:"w-full h-48",children:jsxRuntimeExports.jsx(ResponsiveContainer,{width:"100%",height:"100%",children:jsxRuntimeExports.jsxs(LineChart,{data:chartData.data,margin:{top:5,right:30,left:0,bottom:5},children:[jsxRuntimeExports.jsx(CartesianGrid,{strokeDasharray:"3 3",stroke:"hsl(var(--border))",opacity:.5,vertical:!1}),jsxRuntimeExports.jsx(XAxis,{dataKey:"day",stroke:"hsl(var(--muted-foreground))",style:{fontSize:"11px"}}),jsxRuntimeExports.jsx(YAxis,{stroke:"hsl(var(--muted-foreground))",style:{fontSize:"11px"}}),jsxRuntimeExports.jsx(Tooltip,{content:jsxRuntimeExports.jsx(CustomTooltip,{}),cursor:{stroke:"hsl(var(--accent))",strokeWidth:1,opacity:.3}}),jsxRuntimeExports.jsx(Legend,{wrapperStyle:{paddingTop:"10px",fontSize:"11px"},iconType:"line"}),chartData.products.map((product,index)=>jsxRuntimeExports.jsx(Line,{type:"monotone",dataKey:product.id,name:product.name,stroke:product.color,strokeWidth:2,dot:{fill:product.color,r:3,strokeWidth:1,stroke:"hsl(var(--background))"},activeDot:{r:5,strokeWidth:2},animationBegin:index*80,animationDuration:600,animationEasing:"ease-in-out"},product.id))]})})})}function StockSummaryContent(){const[refreshTrigger,setRefreshTrigger]=reactExports.useState(0),[showManageProducts,setShowManageProducts]=reactExports.useState(!1);return jsxRuntimeExports.jsxs("div",{className:"flex-1 space-y-6 p-4 sm:p-6 lg:p-8",children:[jsxRuntimeExports.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4",children:[jsxRuntimeExports.jsxs("div",{children:[jsxRuntimeExports.jsx("h1",{className:"text-3xl font-bold tracking-tight text-foreground",children:"Stok LPG"}),jsxRuntimeExports.jsxs("p",{className:"text-muted-foreground mt-1",children:["Pantau dan kelola ketersediaan LPG. Klik ",jsxRuntimeExports.jsx("strong",{children:"Edit"})," pada card untuk update stok."]})]}),jsxRuntimeExports.jsxs(Button,{variant:"outline",className:"w-full sm:w-auto",onClick:()=>window.location.href="/kelola-produk-lpg",children:[jsxRuntimeExports.jsx(SafeIcon,{name:"Settings",className:"h-4 w-4 mr-2"}),"Kelola Produk LPG"]})]}),jsxRuntimeExports.jsx(StockSummaryCards,{refreshTrigger}),jsxRuntimeExports.jsx("div",{className:"animate-fadeInUp",style:{animationDelay:"0.3s"},children:jsxRuntimeExports.jsxs(Card,{className:"border-2 shadow-soft",children:[jsxRuntimeExports.jsxs(CardHeader,{className:"pb-2 pt-4 px-6",children:[jsxRuntimeExports.jsx(CardTitle,{className:"text-base font-bold",children:"Grafik Pemakaian Mingguan"}),jsxRuntimeExports.jsx(CardDescription,{className:"text-xs",children:"Tren pemakaian stok LPG dalam 7 hari terakhir"})]}),jsxRuntimeExports.jsx(CardContent,{children:jsxRuntimeExports.jsx(StockConsumptionChart,{})})]})})]})}export{StockSummaryContent as default};
