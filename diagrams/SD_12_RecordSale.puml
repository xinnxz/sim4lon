@startuml SD_12_RecordSale
!theme plain
skinparam backgroundColor #FEFEFE
skinparam sequenceArrowThickness 1
skinparam roundcorner 5
skinparam maxmessagesize 200
skinparam sequenceParticipant underline

title SD-12: RECORD SALE (PANGKALAN)\n<size:10>Sistem SIM4LON</size>

actor "Pangkalan" as User
boundary "PenjualanPage" as PP
control "ConsumerOrderService" as COS
database "consumers" as ConsumerDB
database "lpg_prices" as PricesDB
database "pangkalan_stocks" as StockDB
database "consumer_orders" as OrderDB
database "pangkalan_stock_movements" as MovementDB

== Menampilkan Form Penjualan ==

User -> PP : 1: Buka halaman Penjualan
activate PP

PP -> COS : 1.1: getConsumers(pangkalanId)
activate COS
COS -> ConsumerDB : 1.1.1: SELECT * FROM consumers\nWHERE pangkalan_id = ?
activate ConsumerDB
ConsumerDB --> COS : 1.1.1.1: consumerList
deactivate ConsumerDB
COS --> PP : 1.1.2: consumerList
deactivate COS

PP -> COS : 1.2: getStockAndPrices(pangkalanId)
activate COS
COS -> StockDB : 1.2.1: SELECT * FROM pangkalan_stocks\nWHERE pangkalan_id = ?
activate StockDB
StockDB --> COS : 1.2.1.1: stocks
deactivate StockDB
COS -> PricesDB : 1.2.2: SELECT * FROM lpg_prices\nWHERE pangkalan_id = ?
activate PricesDB
PricesDB --> COS : 1.2.2.1: prices
deactivate PricesDB
COS --> PP : 1.2.3: {stocks, prices}
deactivate COS

PP --> User : 1.3: Tampilkan form penjualan\ndengan stok & harga

== Input Penjualan ==

User -> PP : 2: Pilih/input konsumen
User -> PP : 3: Pilih jenis LPG
User -> PP : 4: Input qty
User -> PP : 5: Klik "Simpan"

PP -> COS : 5.1: createSale(saleDto)
activate COS

COS -> StockDB : 5.1.1: SELECT qty FROM pangkalan_stocks\nWHERE pangkalan_id = ? AND lpg_type = ?
activate StockDB
StockDB --> COS : 5.1.1.1: availableQty
deactivate StockDB

alt Stok tidak mencukupi
    COS --> PP : 5.1.2: throw BadRequestException\n"Stok tidak mencukupi"
    PP --> User : 5.1.2.1: Tampilkan error
else Stok mencukupi
    COS -> OrderDB : 5.1.3: SELECT MAX(code) FROM consumer_orders
    activate OrderDB
    OrderDB --> COS : 5.1.3.1: lastCode "PORD-0099"
    deactivate OrderDB
    
    COS -> COS : 5.1.4: generateNewCode()\nâ†’ "PORD-0100"
    COS -> COS : 5.1.5: calculateTotal(qty, sellingPrice)
    COS -> COS : 5.1.6: calculateProfit(selling - cost)
    
    COS -> OrderDB : 5.1.7: INSERT INTO consumer_orders\n{code, pangkalan_id, consumer_id, lpg_type, qty, total}
    activate OrderDB
    OrderDB --> COS : 5.1.7.1: saleId
    deactivate OrderDB
    
    COS -> StockDB : 5.1.8: UPDATE pangkalan_stocks\nSET qty = qty - ?
    activate StockDB
    StockDB --> COS : 5.1.8.1: updated
    deactivate StockDB
    
    COS -> MovementDB : 5.1.9: INSERT INTO pangkalan_stock_movements\n{type='KELUAR', source='SALE'}
    activate MovementDB
    MovementDB --> COS : 5.1.9.1: created
    deactivate MovementDB
    
    COS --> PP : 5.2: ConsumerOrderModel
    deactivate COS
    
    PP --> User : 5.3: Tampilkan pesan sukses
    PP --> User : 5.4: Refresh dashboard
end

deactivate PP

note right of COS
  <b>Multi-tenant</b>
  pangkalan_id dari JWT
  memastikan isolasi data
end note

@enduml
