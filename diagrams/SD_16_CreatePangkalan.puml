@startuml SD_16_CreatePangkalan
!theme plain
skinparam backgroundColor #FEFEFE
skinparam sequenceArrowThickness 1
skinparam roundcorner 5
skinparam maxmessagesize 200
skinparam sequenceParticipant underline

title SD-16: CREATE PANGKALAN\n<size:10>Sistem SIM4LON</size>

actor "Admin" as Admin
boundary "PangkalanPage" as PP
control "PangkalanService" as PS
database "pangkalans" as PangkalanDB
database "users" as UsersDB
database "activity_logs" as LogsDB

== Menampilkan Daftar Pangkalan ==

Admin -> PP : 1: Buka halaman Master Pangkalan
activate PP

PP -> PS : 1.1: getPangkalanList(page, limit)
activate PS
PS -> PangkalanDB : 1.1.1: SELECT * FROM pangkalans\nWITH users LIMIT ? OFFSET ?
activate PangkalanDB
PangkalanDB --> PS : 1.1.1.1: pangkalanList
deactivate PangkalanDB
PS --> PP : 1.1.2: {data, total, page}
deactivate PS

PP --> Admin : 1.2: Tampilkan daftar pangkalan

== Tambah Pangkalan Baru ==

Admin -> PP : 2: Klik "Tambah Pangkalan"
PP --> Admin : 2.1: Tampilkan form

Admin -> PP : 3: Input nama, alamat, region
Admin -> PP : 4: Input PIC, phone, email
Admin -> PP : 5: Input kapasitas, alokasi_bulanan
Admin -> PP : 6: Input login_email (opsional)
Admin -> PP : 7: Input login_password (opsional)
Admin -> PP : 8: Klik "Simpan"

PP -> PS : 8.1: createPangkalan(pangkalanDto)
activate PS

PS -> PS : 8.1.1: validateInput(pangkalanDto)

opt login_email ada
    PS -> UsersDB : 8.1.2: SELECT * FROM users\nWHERE email = ?
    activate UsersDB
    UsersDB --> PS : 8.1.2.1: existing or null
    deactivate UsersDB
    
    alt Email sudah digunakan
        PS --> PP : 8.1.3: throw BadRequestException\n"Email sudah digunakan"
        PP --> Admin : 8.1.3.1: Tampilkan error
    end
end

== Generate Kode Pangkalan ==

PS -> PangkalanDB : 8.1.4: SELECT COUNT(*) FROM pangkalans
activate PangkalanDB
PangkalanDB --> PS : 8.1.4.1: count
deactivate PangkalanDB

PS -> PS : 8.1.5: generateCode()\n→ "PKL-XXX"

== Simpan Pangkalan ==

PS -> PangkalanDB : 8.1.6: INSERT INTO pangkalans\n{code, name, address, region, pic_name, phone, email, capacity, alokasi_bulanan}
activate PangkalanDB
PangkalanDB --> PS : 8.1.6.1: pangkalanId
deactivate PangkalanDB

== Auto-Create User (jika ada kredensial) ==

opt login_email dan login_password ada
    PS -> UsersDB : 8.1.7: SELECT COUNT(*) FROM users
    activate UsersDB
    UsersDB --> PS : 8.1.7.1: count
    deactivate UsersDB
    
    PS -> PS : 8.1.8: generateUserCode()\n→ "USR-XXX"
    PS -> PS : 8.1.9: bcrypt.hash(password)
    
    PS -> UsersDB : 8.1.10: INSERT INTO users\n{code, email, password, role='PANGKALAN', pangkalan_id}
    activate UsersDB
    UsersDB --> PS : 8.1.10.1: userId
    deactivate UsersDB
    
    note right of PS
      <b>Auto-create user</b>
      dengan role PANGKALAN
      dan link ke pangkalan
    end note
end

PS -> LogsDB : 8.1.11: INSERT INTO activity_logs\n{type='pangkalan_created'}
activate LogsDB
LogsDB --> PS : 8.1.11.1: created
deactivate LogsDB

PS --> PP : 8.2: {pangkalan, user?}
deactivate PS

PP --> Admin : 8.3: Tampilkan pesan sukses
PP --> Admin : 8.4: Refresh daftar

deactivate PP

@enduml
