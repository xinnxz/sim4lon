@startuml SD_04_UpdateStatus
!theme plain
skinparam backgroundColor #FEFEFE
skinparam sequenceArrowThickness 1
skinparam roundcorner 5
skinparam maxmessagesize 200
skinparam sequenceParticipant underline

title SD-04: UPDATE STATUS PESANAN\n<size:10>Sistem SIM4LON</size>

actor "Admin" as Admin
boundary "OrderDetailPage" as ODP
control "OrderService" as OS
database "orders" as OrdersDB
database "order_items" as ItemsDB
database "timeline_tracks" as TimelineDB
database "pangkalan_stocks" as StockDB

== Menampilkan Detail Pesanan ==

Admin -> ODP : 1: Buka detail pesanan
activate ODP
ODP -> OS : 1.1: getOrderDetail(orderId)
activate OS
OS -> OrdersDB : 1.1.1: SELECT * FROM orders\nJOIN items, timeline, payment
activate OrdersDB
OrdersDB --> OS : 1.1.1.1: orderData
deactivate OrdersDB
OS --> ODP : 1.1.2: orderDetail
deactivate OS
ODP --> Admin : 1.2: Tampilkan detail pesanan

== Update Status ==

Admin -> ODP : 2: Pilih status baru
Admin -> ODP : 3: Klik "Update Status"

ODP -> OS : 3.1: updateStatus(orderId, newStatus, driverId?)
activate OS

OS -> OrdersDB : 3.1.1: SELECT current_status FROM orders\nWHERE id = ?
activate OrdersDB
OrdersDB --> OS : 3.1.1.1: currentStatus
deactivate OrdersDB

OS -> OS : 3.1.2: validateTransition(current, new)

alt Transisi tidak valid
    OS --> ODP : 3.1.3: throw BadRequestException
    ODP --> Admin : 3.1.3.1: Tampilkan error\n"Transisi tidak valid"
else Transisi valid
    
    opt Status = SIAP_KIRIM dan driverId ada
        OS -> OrdersDB : 3.1.4: UPDATE orders\nSET driver_id = ?
        activate OrdersDB
        OrdersDB --> OS : 3.1.4.1: updated
        deactivate OrdersDB
    end
    
    OS -> OrdersDB : 3.1.5: UPDATE orders\nSET current_status = ?
    activate OrdersDB
    OrdersDB --> OS : 3.1.5.1: updated
    deactivate OrdersDB
    
    OS -> TimelineDB : 3.1.6: INSERT INTO timeline_tracks\n{order_id, status, description}
    activate TimelineDB
    TimelineDB --> OS : 3.1.6.1: created
    deactivate TimelineDB
    
    opt Status = SELESAI
        OS -> ItemsDB : 3.1.7: SELECT * FROM order_items\nWHERE order_id = ?
        activate ItemsDB
        ItemsDB --> OS : 3.1.7.1: items[]
        deactivate ItemsDB
        
        loop untuk setiap item
            OS -> StockDB : 3.1.8: UPDATE pangkalan_stocks\nSET qty = qty + ?
            activate StockDB
            StockDB --> OS : 3.1.8.1: updated
            deactivate StockDB
        end
        
        note right of OS
          <b>Auto-sync stok pangkalan</b>
          saat pesanan SELESAI
        end note
    end
    
    OS --> ODP : 3.2: updatedOrder
    deactivate OS
    
    ODP --> Admin : 3.3: Tampilkan pesan sukses
    ODP --> Admin : 3.4: Refresh halaman
end

deactivate ODP

@enduml
